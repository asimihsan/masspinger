<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7 ]> <html class="no-js ie6 ielt7 ielt8 ielt9" lang="en"> <![endif]-->
<!--[if IE 7 ]>    <html class="no-js ie7 ielt8 ielt9" lang="en"> <![endif]-->
<!--[if IE 8 ]>    <html class="no-js ie8 ielt9" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>masspinger</title>
  <meta name="description" content="Monitor network machines using ICMP, HTTP, and SIP.">
  <meta name="author" content="Asim Ihsan">

  <!-- Mobile viewport optimized: j.mp/bplateviewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS: implied media="all" -->
  <link href='http://fonts.googleapis.com/css?family=Quattrocento' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="css/style.css?v=2">  
  <link href="css/desert.css" type="text/css" rel="stylesheet">

  <!-- Uncomment if you are specifically targeting less enabled mobile browsers
  <link rel="stylesheet" media="handheld" href="css/handheld.css?v=2">  -->

  <!-- All JavaScript at the bottom, except for Modernizr which enables HTML5 elements & feature detects -->
  <script src="js/libs/modernizr-1.7.min.js"></script>

</head>

<body class="single" onload="prettyPrint()">
  
  <div id="screen">    
    <header>
        <div id="namebar"><a href="http://www.asimihsan.com">Asim Ihsan</a></div>
        <h1>masspinger - a cross-platform network monitor</h1>
        <ul>
            <li><a href="#introduction">Introduction</a></li>
            <li><a href="#installation">Installation and quick start</a>
            <ul>
                <li><a href="#installation_windows">Windows</a></li>
                <li><a href="#installation_ubuntu">Ubuntu</a></li>
                <li><a href="#installation_usage">Usage</a></li>
            </ul>            
            </li>
            <li><a href="#download">Download</a></li>            
            <li><a href="#building">Building from source</a>
            <ul>
                <li><a href="#building_windows">Windows</a></li>
                <li><a href="#building_ubuntu">Ubuntu</a></li>
            </ul>
            </li>            
            <li><a href="#troubleshooting">Troubleshooting</a></li>
            <li><a href="#developer">Developer's guide</a></li>
            <li><a href="#future">Future development</a></li>
            <li><a href="#changelog">Software and document changelog</a>
            <ul>
                <li><a href="#changelog_software">Software</a></li>
                <li><a href="#changelog_document">Document</a></li>
            </ul>
            </li>
            <li><a href="#comments">Comments</a></li>
        </ul>        
    </header>
    <section id="content" class="G4 GS">
        <article><div class="formatted">
            
            <h2><a name="introduction">Introduction</a></h2>            
                <p>masspinger is a command-line tool that uses ICMP pings, and in the future HTTP GETs and SIP REGISTERs/calls, to continuously monitor network machines. It is intended for deployment by network administrators as part of a broader network monitoring system. It supports both Windows and Linux operating systems.</p>      
                <p>masspinger leverages asynchronous I/O, also known as non-blocking I/O, as opposed to using a threaded model, so that it may monitor very large numbers of hosts at a lesser cost<a href="#reference_1">[1]</a>.  Morever, rather than plough in lots of additional functionality in order to display/track gathered results it uses the <a href="http://www.zeromq.org/">ZeroMQ</a> socket library to communicate its results.  This will allow network administrators to efficiently and scalably use masspinger as a lower-level building block for constructs written in higher-level languages.  Please see the <a href="#developer">Developer's Guide</a> for more information.</p>            
            <h2><a name="installation">Installation and quick start guide</a></h2>
            <h3><a name="installation_windows">Windows</a></h3>
            <p>The following have been tested on Windows XP SP2 and Windows 7, but should also other compatible versions of Windows.  In order to use masspinger you need Administrator access on the machine it runs on.</p>
            <ul>
                <li>Either <a href="#download">download the ZIP package of the GitHub repo</a> or <span class="mono">git clone</span> it.</li>
                <li>The <span class="mono">masspinger/bin/win32/release</span> folder contains <span class="mono">masspinger.exe</span> and other required DLL files that must remain in the same directory.</li>
                <li>If you do not have Microsoft Visual Studio (MSVC) 2008 or later installed on the machine download and install the <a href="http://preview.tinyurl.com/29563wl">MSVC 2008 Redistributable Package (x86)</a>.</li>
                <li>Try to execute <span class="mono">masspinger.exe</span> without any command-line arguments. You should get a print-out of the usage text.</li>                
            </ul>
            <p>Uninstallation involves deleting the files you've downloaded; no other files or Registry settings are altered.</p>
            <h3><a name="installation_ubuntu">Ubuntu</a></h3>
            <p>The following have been testing on Ubuntu Maverick 10.10 but should work on all compatible versions of Ubuntu, and with appropriate modifications on any Linux platform that supports all the libraries used (e.g. RedHat).  You must have root user privileges in order to use <span class="mono">masspinger</span>.</p>
            <ul>
                <li>Follow the <a href="#building_ubuntu">instructions for building the code from source</a>.</li>
                <li>Try to execute <span class="mono">masspinger</span> without any command-line arguments. You should get a print-out of the usage text.</li>
            </ul>
            <h3><a name="usage">Usage</a></h3>            
            <p><pre class="literal-block">
C:\masspinger&gt;masspinger.exe
Need to specify at least one host to monitor.
Allowed options:
  --help                   Produce help message.
  -H [ --host ] arg        An IP address or DNS hostname to monitor using ICMP
                           pings.
  -b [ --zeromq_bind ] arg One or more ip_address:port pairs to publish ZeroMQ
                           messages from, e.g. 'tcp://127.0.0.1:5556'.
  -V [ --verbose ]         Verbose debug output.            
            </span></pre></p>
            <p>For example:</p>
            <pre class="literal-block">masspinger.exe 192.168.0.1 192.168.0.100 -b tcp://*:5556 -V</pre>
            <p>will continuously send ICMP pings at an interval of one second to the hosts <span class="mono">192.168.0.1</span> and <span class="mono">192.168.0.100</span>, publish the results on all interfaces over TCP on port 5556, and show verbose diagnostics about low-level events. A further example:
            <pre class="literal-block">./masspinger hostname1 hostname2 hostname3 hostname4 hostname5 -b tcp://10.0.0.1:5556 -b tcp://10.0.0.2:5556</pre></p>
            <p>will monitor all five hosts mentioned and publish the results on two different TCP bindings.  These could correspond to different Ethernet interfaces and hence provide fault-tolerance in the case of a layer 2 failure on a given interface, assuming the two interfaces are truly orthogonal.</p>   
            <p>As a starting point for developing higher-level tools that use masspinger, see <span class="mono">massping/tools/python_client.py</span> as an example.  It just subscribes for all ZeroMQ publish messages and a variable number of bindings and logs them to the console.  You'll need to <a href="http://www.zeromq.org/bindings:python">install the Python bindings for ZeroMQ</a> in order to use this tool. <a href="https://launchpad.net/~chris-lea/+archive/zeromq">Here is an up-to-date Ubuntu repo to use for the bindings</a>.</p>            
            <h2><a name="download">Download</a></h2>                
      <a href="http://github.com/asimihsan/masspinger/zipball/master">
        <img border="0" width="90" src="http://github.com/images/modules/download/zip.png" /></a>
      <a href="http://github.com/asimihsan/masspinger/tarball/master">
        <img border="0" width="90" src="http://github.com/images/modules/download/tar.png" /></a>        
            
                 
            <h2><a name="building">Building from source</a></h2>
            <h3><a name="building_windows">Windows</a></h3>
            <ul>
            <li>Requires <a href="http://preview.tinyurl.com/3uak9fb">Microsoft Visual Studio 2008</a> and git.  I prefer to use the <a href="http://www.cygwin.com/">cygwin</a> version of git.</li>
            <li>Download latest version of <a href="http://www.boost.org/">Boost</a>.  Extract to e.g. c:\libs\boost\</li>
            <li>Follow the <a href="http://www.boost.org/doc/libs/1_46_1/more/getting_started/windows.html">Boost "Getting Started" instructions</a> to build the Boost binaries.  This is essentially opening a Microsoft Visual Studio command prompt, changing directory to the root of the folder where you extracted Boost to, and executing:<br /><br />
            <pre class="literal-block">bootstrap
./bjam</pre>
            This will take a long time.</li>
            <li>The Boost binaries should now be in e.g. <span class="mono">c:\libs\boost\stage\lib\</span></li>
            <li>Add a pair of system environment variables:
            <ul>
                <li><span class="mono">BOOST_HOME = c:\libs\boost\</span></li>
                <li><span class="mono">BOOST_LIB = c:\libs\boost\stage\lib\</span></li>
            </ul>
            <li>From a command prompt execute the following in order to clone a copy of the repository:<br /><br />
            <pre class="literal-block">git clone git://github.com/asimihsan/masspinger.git</pre></li>
            <li>Open <span class="mono">deps/win32/log4cxx/projects/log4cxx.sln</span> in Microsoft Visual Studio. Change the active solution current configuration to "Release" and build the whole solution.  This will result in a dynamic DLL called <span class="mono">"log4cxx.dll"</span> and other files required for building inside <span class="mono">bin/win32/release/</span>.</li>
            <li>Open <span class="mono">deps/win32/zeromq/builds/msvc/msvc.sln</span> in Microsoft Visual Studio. Change the active solution configuration to "Release" and build the whole solution.  This will result in a dynamic DLL called <span class="mono">"libzmq.dll"</span> and other files required for building inside <span class="mono">bin/win32/release/</span>.</li>
            <li>Open <span class="mono">deps/win32/yaml-cpp/yamlcpp.sln</span> in Microsoft Visual Studio. Change the active solution current configuration to "Release" and build the whole solution.  This will result in a static library called <span class="mono">"yamlcpp.lib"</span> inside <span class="mono">bin/win32/release/</span>.</li>            
            <li>Open <span class="mono">build/msvc/masspinger.sln</span> in Microsoft Visual Studio.  Change the active solution configuration to "Release" and build the whole solution.  This will result in an EXE called <span class="mono">masspinger.exe</span> inside <span class="mono">bin/win32/release/</span>.</li>
            </ul>

            <h3><a name="building_ubuntu">Ubuntu</a></h3>            
            <p><ul>            
                <li>Download the latest version of <a href="http://www.boost.org">Boost</a> as source code, extact it into e.g. <span class="mono">/usr/local/lib/boost_1_46_0</span>, and build it into the same directory using <a href="http://www.boost.org/doc/libs/1_46_1/more/getting_started/unix-variants.html">these instructions</a>.</li>
                <li>The Boost binaries should now be inside e.g. <span class="mono">/usr/local/lib/boost_1_46_0/stage/lib/</span>.</li>
                <li>Add e.g. <span class="mono">/usr/local/lib/boost_1_46_0/stage/lib/</span> to <span class="mono">/etc/ld.so.conf</span> and then execute:<br /><br /><pre class="literal-block">ldconfig</pre></li>.
                <li><span class="mono">masspinger</span> requires <span class="mono">log4cxx</span> but I haven't been able to successfully build it from source, so execute:<br /><br /><pre class="literal-block">sudo apt-get install liblog4cxx10 liblog4cxx10-dev</pre></li>                
                <li>Either <a href="http://www.zeromq.org/intro:get-the-software">install the latest version of ZeroMQ from source</a> (very easy) or install the latest version of ZeroMQ from Chris Lea's PPA, i.e.:<br /><br />
<pre class="literal-block">sudo add-apt-repository ppa:chris-lea/zeromq
sudo apt-get update
sudo apt-get install zeromq-bin libzmq-dbg libzmq-dev libzmq0</pre>
                <li>Download and install <a href="https://code.google.com/p/yaml-cpp/">yaml-cpp</a>, move the resulting static libary to /usr/local/lib/, and then execute ldconfig</li>.
                <li>Git clone a copy of the repository:<br /><br />
                <pre class="literal-block">git clone git://github.com/asimihsan/masspinger.git</pre></li>
                <li>Change directory to the src directory, then run:<br /><br />
                <pre class="literal-block">g++ -O3 -I /usr/local/lib/boost_1_46_0/ -lboost_system -lboost_program_options -llog4cxx -lzmq -lyaml-cpp -Wall -ansi -pedantic `ls *.cpp | xargs` -o masspinger</pre>
                </li>
            </ul></p>

            <h2><a name="troubleshooting">Troubleshooting</a></h2>
            <ul>
                <li>Q: masspinger isn't doing anything!<br />
                A: Turn on verbose trace using the <span class="mono">--verbose</span> command-line argument to confirm that the tool is attempting to do something.  Then use <a href="http://www.wireshark.org/">Wireshark</a> or tcpdump to confirm whether e.g. ICMP pings are leaving your box and whether any responses are coming back.  Keep in mind that <a href="http://wiki.wireshark.org/CaptureSetup/Loopback">you cannot sniff on the loopback interface on Windows</a>, so absence on traffic in this scenario doesn't imply a lack of traffic.
                </li>                                    
            
            <h2><a name="developer">Developer's guide</a></h2>
            <p>The purpose of masspinger is to monitor the responsiveness of a large number of networked hosts using a wide variety of protocols.  Currently it only supports ICMP ECHO_REQUESTs but I intend to support HTTP GETs/POSTs and SIP REGISTERs in the future.  masspinger is written in C++ and make heavy use of <a href="http://www.boost.org/">Boost</a>, <a href="http://www.zeromq.org/">ZeroMQ</a>, and <a href="http://logging.apache.org/log4cxx/index.html">log4cxx</a>.</p>
            <p>masspinger's main function is mostly a lot of boilerplate that handles the command-line arguments.  At its heart is this section at the bottom:
<pre class="prettyprint">// src/ping.cpp<br />
boost::asio::io_service io_service;
boost::shared_ptr<Pinger> ping_receiver(new Pinger(io_service, hosts, zeromq_binds, logger));
io_service.run();
</pre></p>                  
            <p>The <span class="mono">Pinger</span> instance is a single object given <span class="mono">hosts</span>, a vector of strings corresponding to hostnames and/or IPv4 addresses to monitor, and <span class="mono">zeromq_binds</span>, a vector of strings of addresses that ZeroMQ can bind to in order to publish results.  In order to add future functionality, e.g. <span class="mono">HttpMonitor</span> or <span class="mono">SipMonitor</span>, a new class with a similar constructor prototype would be needed and would use the same <span class="mono">io_service</span> instance.  The intention is for all monitoring types to not require additional threads to operate.  For an accessible tutorial to Boost ASIO please see <a href="#reference_2">[2]</a>.</p>
            <p>Before I move onto the details of the <span class="mono">Pinger</span> class, a quick word about ZeroMQ.  It is extremely easy to use; <a href="http://zguide.zeromq.org/page:all">Chapter 1 of ZeroMQ's excellent guide</a> should provide a sufficient background to develop clients that listen for ZeroMQ messages from masspinger.  Keep in mind that all the examples in the manual usually have equivalents in other languages. As a quick and dirty example of a Python client take a look at <span class="mono">tools/python_client.py</span>.</p>
            <p>The <span class="mono">Pinger</span> class is rather unusual as a consequence of how ICMP sockets work, or rather that lack thereof.  It is impossible to receive ICMP ECHO_REPLYs from a given host.  Instead one must bind to a raw socket and receive all ICMP ECHO_REPLYs incoming to the host.  Hence, the flow of Pinger's constructor is to:
            <ul>
                <li>For each requested ZeroMQ binding, call <span class="mono">zmq_bind()</span> with the <span class="mono">ZMQ_PUB</span> socket option.</li>
                <li>For each host we're monitoring, get the IP address it uses and call <span class="mono">start_send()</span> with a <span class="mono">Host</span> instance wrapping around its details.  <span class="mono">start_send()</span> uses a timer to send an ICMP ECHO_REQUEST once a second to the host.</li>
                <li>Call <span class="mono">start_receive()</span> <strong>once</strong>.  This is a non-blocking receive that uses <span class="mono">handle_receive()</span> as the callback for all received ICMP packets.</li>
            </ul></p>
            <p>Here's a diagram showing two instances of masspinger, each monitoring a host:
            <img src="img/basic_1.png" width=761 height=282 alt="Basic ICMP and ZeroMQ message timeline." />
                    <figcaption>Basic ICMP and ZeroMQ message timeline.</figcaption>            
            </p>
            
            <h2><a name="future">Future development</a></h2>            
            <p>
            <ul>
                <li>Handle all potential exceptions.  For example, entering in an unresolvable hostname causes a crash.</li>
                <li>Hostnames that resolve to more than one IP address crash the script.  Ideally we monitor the first IP address and periodically re-resolve the hostname.</li>
                <li>Add SIP REGISTER, HTTP GET, HTTP POST monitoring.</li>
                <li>Offer file-based configuration.  Doesn't seem feasible to pass absolutely everything via the command-line.</li>
                <li>Offer file-based log4cxx configuration.  Admins may have unusual logging requirements, or platform-specific requirements (e.g. using the Windows Event logger).</li>
                <li>Create a fancier front-end example, perhaps web based and offering historical tracking.</li>
                <li>Use a more efficient protocol.  Encoding YAML messages over ZeroMQ sounds perfect but the yaml-cpp requires an unusually large amount of CPU power to encode message.  Maybe Google Protocol Buffers instead?</li>
                <li>Rather than have masspinger publish all ICMP results over ZeroMQ it makes more sense to publishes periodic summaries of host responsiveness, in order to reduce traffic.  However, it must guarantee immediate notification of hosts becoming unresponsive.</li>
            </ul>
            </p>
            
            <h2><a name="references">References</a></h2>
            <ol>
                <li><a id="reference_1" href="https://secure.wikimedia.org/wikipedia/en/wiki/Asynchronous_I/O">Asynchronous I/O</a>, Wikipedia.</li>
                <li><a id="reference_2" name="reference_2"></a><a href="http://en.highscore.de/cpp/boost/">The Boost C++ Libraries</a>, Boris Schäling.</li>
            </ol>
            
            
            <h2><a name="developer">Software and document changelog</a></h2>
            
            
            </div>            
        </article>            
        
        <a name="comments"><div id="disqus_thread"></div></a>
        <script type="text/javascript">                
            var disqus_shortname = 'asimihsan'; // required: replace example with your forum shortname    
            var disqus_identifier = 'masspinger';
            var disqus_url = 'http://www.asimihsan.com/masspinger/';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>    
    </section>
    
    <footer>
        Copyright (c) 2011 Asim Ihsan (asim dot ihsan at gmail dot com).
    </footer>
  </div> <!--! end of #screen -->

  <!-- JavaScript at the bottom for fast page loading -->

  <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if necessary -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
  <script>window.jQuery || document.write('<script src="js/libs/jquery-1.5.1.min.js">\x3C/script>')</script>

  <!-- scripts concatenated and minified via ant build script-->
  <script src="js/plugins.js"></script>
  <script src="js/script.js"></script>
  <!-- end scripts-->
  
  <script src="js/libs/prettify/prettify.js"></script>

  <!--[if lt IE 7 ]>
    <script src="js/libs/dd_belatedpng.js"></script>
    <script>DD_belatedPNG.fix('img, .png_bg'); // Fix any <img> or .png_bg bg-images. Also, please read goo.gl/mZiyb </script>
  <![endif]-->


    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-22019953-1']);
        _gaq.push(['_trackPageview']);
        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>  

</body>
</html>